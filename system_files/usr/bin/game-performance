#!/usr/bin/env bash
# Helper script to enable the performance profile with proton or others
# For Bazzite-based images using tuned profiles

# Check if tuned-adm is available
if ! command -v tuned-adm &>/dev/null; then
    echo "Error: tuned-adm not found" >&2
    exit 1
fi

# Set performance profile with tuned using Bazzite's custom profiles
if [ -n "$GAME_PERFORMANCE_SCREENSAVER_ON" ]; then
    # Allow screensaver, just set profile and run
    tuned-adm profile throughput-performance-bazzite 2>/dev/null || \
        tuned-adm profile throughput-performance
    exec "$@"
else
    # Save current profile to restore later
    ORIGINAL_PROFILE=$(tuned-adm active 2>/dev/null | cut -d: -f2 | tr -d ' ')
    
    # Set performance profile
    tuned-adm profile throughput-performance-bazzite 2>/dev/null || \
        tuned-adm profile throughput-performance
    
    # Inhibit screensaver and run the game
    systemd-inhibit --why "game-performance is running" -- "$@"
    
    # Restore previous profile after game exits
    if [ -n "$ORIGINAL_PROFILE" ]; then
        tuned-adm profile "$ORIGINAL_PROFILE"
    else
        tuned-adm profile balanced-bazzite 2>/dev/null || \
            tuned-adm profile balanced
    fi
fi